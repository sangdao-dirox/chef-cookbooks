#
# Nginx configuration file for <%= @application %>
#
# Generated by Chef for <%= node[:fqdn] %>
#

upstream phpfcgi {
    # server 127.0.0.1:9000;
    server unix:/var/run/php-fpm-www.sock;
}

server {
    listen 80;
    listen 443 ssl;
    server_name _;

    <% if @ssl_enabled %>
    ssl_certificate      <%= @application %>.crt;
    ssl_certificate_key  <%= @application %>.key;

    ssl_protocols  SSLv2 SSLv3 TLSv1;
    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
    ssl_prefer_server_ciphers   on;
    <% end %>

    set $ssl off;
    if ($scheme = https) {
        set $ssl on;
    }

    root /srv/www/<%= @application %>/current/web;

    # strip app.php/ prefix if it is present
    rewrite ^/app\.php/?(.*)$ /$1 permanent;

    location / {
        index app.php;
        try_files $uri @rewriteapp;
    }

    location @rewriteapp {
        rewrite ^(.*)$ /app<% if @dev %>_dev<% end %>.php/$1 last;
    }

    # pass the PHP scripts to FastCGI server from upstream phpfcgi
    location ~ ^/(app|app_dev|config)\.php(/|$) {
        fastcgi_pass phpfcgi;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param  HTTPS $ssl;
    }
}
